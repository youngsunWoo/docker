<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter10 자바가상머신(JVM)이해하기 | Sunny Archive</title>
    <meta name="description" content="개발 관련 블로그">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/sunny-archive/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/sunny-archive/assets/css/0.styles.a7ac78a8.css" as="style"><link rel="preload" href="/sunny-archive/assets/js/app.20f77d52.js" as="script"><link rel="preload" href="/sunny-archive/assets/js/2.511b4fc5.js" as="script"><link rel="preload" href="/sunny-archive/assets/js/4.360058bb.js" as="script"><link rel="prefetch" href="/sunny-archive/assets/js/10.a0ef1271.js"><link rel="prefetch" href="/sunny-archive/assets/js/11.6541ddd8.js"><link rel="prefetch" href="/sunny-archive/assets/js/12.1903e15c.js"><link rel="prefetch" href="/sunny-archive/assets/js/13.197863a7.js"><link rel="prefetch" href="/sunny-archive/assets/js/14.9b068972.js"><link rel="prefetch" href="/sunny-archive/assets/js/15.54027cd4.js"><link rel="prefetch" href="/sunny-archive/assets/js/16.524f5d92.js"><link rel="prefetch" href="/sunny-archive/assets/js/17.11708487.js"><link rel="prefetch" href="/sunny-archive/assets/js/18.5d867f86.js"><link rel="prefetch" href="/sunny-archive/assets/js/19.0f648627.js"><link rel="prefetch" href="/sunny-archive/assets/js/20.27ef1d38.js"><link rel="prefetch" href="/sunny-archive/assets/js/21.77345df6.js"><link rel="prefetch" href="/sunny-archive/assets/js/22.085befa6.js"><link rel="prefetch" href="/sunny-archive/assets/js/23.8490966f.js"><link rel="prefetch" href="/sunny-archive/assets/js/24.ec8405cd.js"><link rel="prefetch" href="/sunny-archive/assets/js/25.b0db359b.js"><link rel="prefetch" href="/sunny-archive/assets/js/26.46aa84cd.js"><link rel="prefetch" href="/sunny-archive/assets/js/27.8c499cc1.js"><link rel="prefetch" href="/sunny-archive/assets/js/28.a0f23262.js"><link rel="prefetch" href="/sunny-archive/assets/js/3.6c4817b1.js"><link rel="prefetch" href="/sunny-archive/assets/js/5.c75d34e9.js"><link rel="prefetch" href="/sunny-archive/assets/js/6.7ef6ecd2.js"><link rel="prefetch" href="/sunny-archive/assets/js/7.e7a5c462.js"><link rel="prefetch" href="/sunny-archive/assets/js/8.07adb725.js"><link rel="prefetch" href="/sunny-archive/assets/js/9.026c5ddc.js">
    <link rel="stylesheet" href="/sunny-archive/assets/css/0.styles.a7ac78a8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sunny-archive/" class="home-link router-link-active"><!----> <span class="site-name">Sunny Archive</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/youngsunWoo/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/youngsunWoo/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/sunny-archive/" class="sidebar-heading clickable router-link-active open"><span>책읽기</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>JAVA</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>JAVA 프로그래밍 면접 이렇게 준비한다</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/sunny-archive/java/interview_Expose/Chapter06.html" class="sidebar-link">Chapter06# 디자인패턴</a></li><li><a href="/sunny-archive/java/interview_Expose/Chapter08.html" class="sidebar-link">Chapter08# 자바기본(1)</a></li><li><a href="/sunny-archive/java/interview_Expose/Chapter10.html" class="active sidebar-link">Chapter10# 자바가상머신(JVM)이해하기</a></li><li><a href="/sunny-archive/java/interview_Expose/Chapter14.html" class="sidebar-link">Chapter14# HTTP</a></li><li><a href="/sunny-archive/java/interview_Expose/Chapter16.html" class="sidebar-link">Chapter16# 스프링 프레임워크</a></li><li><a href="/sunny-archive/java/interview_Expose/Chapter17.html" class="sidebar-link">Chapter17# 하이버네이트 사용하기</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>스프링 인 액션</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chapter10-자바가상머신-jvm-이해하기"><a href="#chapter10-자바가상머신-jvm-이해하기" class="header-anchor">#</a> Chapter10 자바가상머신(JVM)이해하기</h1> <p></p><div class="table-of-contents"><ul><li><a href="#가비지컬렉션">가비지컬렉션</a><ul><li><a href="#q1-메모리를-어떻게-할당-하는가">Q1. 메모리를 어떻게 할당 하는가</a></li><li><a href="#q2-garbage-collection-gc-이란-무엇인가">Q2. Garbage Collection(GC)이란 무엇인가?</a></li></ul></li><li><a href="#메모리튜닝">메모리튜닝</a><ul><li><a href="#q1-스택과-힙의-차이는-무엇인가">Q1. 스택과 힙의 차이는 무엇인가?</a></li><li><a href="#q2-jvm의-힙-크기는-어떻게-지정할-수-있는가">Q2. JVM의 힙 크기는 어떻게 지정할 수 있는가</a></li><li><a href="#q3-자바에서-메모리-누수가-발생할-수-있는가">Q3. 자바에서 메모리 누수가 발생할 수 있는가?</a></li></ul></li><li><a href="#jvm과-자바-사이의-상호작용">JVM과 자바 사이의 상호작용</a><ul><li><a href="#q1-jvm에서-동작하는-실제-자바-코드를-작설할때-생명주기란-무엇인가">Q1 JVM에서 동작하는 실제 자바 코드를 작설할때 생명주기란 무엇인가?</a></li><li><a href="#q2-jvm에게-가비지컬렌션-실행하라고-직접-명령-할-수-있는가">Q2 JVM에게 가비지컬렌션 실행하라고 직접 명령 할 수 있는가?</a></li><li><a href="#q3-finalize-메서드는-어떤-역할을-수행하는가">Q3 finalize 메서드는 어떤 역할을 수행하는가?</a></li><li><a href="#q4-weakreference란-무엇인가">Q4 WeakReference란 무엇인가?</a></li><li><a href="#q5-native-메서드란-무엇인가">Q5 native 메서드란 무엇인가?</a></li><li><a href="#q6-셧다운-훅이란-무엇인가">Q6 셧다운 훅이란 무엇인가?</a></li></ul></li></ul></div><p></p> <h2 id="가비지컬렉션"><a href="#가비지컬렉션" class="header-anchor">#</a> 가비지컬렉션</h2> <h3 id="q1-메모리를-어떻게-할당-하는가"><a href="#q1-메모리를-어떻게-할당-하는가" class="header-anchor">#</a> <code>Q1. 메모리를 어떻게 할당 하는가</code></h3> <p>new키워드를 사용해 heap영역에 메모리가 할당된다.
메모리가 충분하지 않으면 Garbage Collection(GC)를 이용해 메모리를 확보하며 그래도 충분치 않으면 OutOfMemoryError가 발생한다.</p> <p>heap영역은 여러개의 제너레이션으로 나누어지며 GC를 통해 다른 제너레이션으로 이동한다.</p> <ul><li>Young : 객체가 처음 생성되면 Eden 메모리 영역에 할당되며 GC의 수집대상에서 벗어나면 Survive라는 메모리 영역으로 옮겨진다</li> <li>Old : 이후 Tenured 제너레이션에 할당된다. Tenured 제너레이션은 GC의 수집대상 빈도가 적다.</li> <li>PermArea : Permanent 제너레이션 or PermGen이라는 공간은 GC에서 수집대상으로 선택되지 않으며, 주로 클래스 정의나 String 상수같은 불변상태들이 포함된다.<br>
자바8에서 PermGen -&gt; Mataspace(물리영역)으로 변경되었다.</li></ul> <h3 id="q2-garbage-collection-gc-이란-무엇인가"><a href="#q2-garbage-collection-gc-이란-무엇인가" class="header-anchor">#</a> <code>Q2. Garbage Collection(GC)이란 무엇인가?</code></h3> <p>가비지 컬렉션은 기존의 할당된 메모리를 재사용 메커니즘이다.
new키워드로 객체가 생성시 메모리를 할당하고 해제 시 JVM메모리 공간을 재 배치한다.<br>
C,C++은 GC가 존재하지 않으므로 수동으로 메모리를 해제 해주어야 하나 JAVA는 메모리에 대한 해제를 직접 수행할 필요가 없다.</p> <p><strong>전통적인 알고리즘은 mark-and-sweep방식이다.</strong></p> <ul><li>실행중인 코드에서 참조되는 객체 및 해당 객체에서 참조되는 것들이 live로 표시</li> <li>live로 표시 되지 않은 객체들을 찾아 해당 위치에 메모리가 할당 될 수 있도록 한다.</li> <li>해당 과정에서 메모리를 재 배치하며 JVM의 스레드가 모두 정지(stop-the-world)한다.</li></ul> <p><strong>GC의 종류</strong></p> <ul><li>마이너 GC: Young 영역에서 발생하는 GC</li> <li>메이저 GC: Old 영역이나 Perm 영역에서 발생하는 GC</li></ul> <p><strong>Compaction</strong></p> <ul><li>자바6에서 GC1이 처음 등장했으며 자바7에서 본격적으로 도입되었다.</li> <li>GC1 역시 mark-and-sweep에 집중하며 가등한 많은 공간을 비우려 한다.</li> <li>결과적으로 GC는 메모리에서 객체를 옮기고 자주 접근되는 객체를 묶어두는데 이 작업을 compaction이라고 한다.</li></ul> <p><img src="/sunny-archive/assets/img/heap.2bfc3aee.png" alt="메모리구분"></p> <hr> <h2 id="메모리튜닝"><a href="#메모리튜닝" class="header-anchor">#</a> 메모리튜닝</h2> <h3 id="q1-스택과-힙의-차이는-무엇인가"><a href="#q1-스택과-힙의-차이는-무엇인가" class="header-anchor">#</a> <code>Q1. 스택과 힙의 차이는 무엇인가?</code></h3> <ul><li><p>스택은 기본값, 객체의 참고, 메소드가 저장되는 위치이며 스택에 있는 변수의 lifeCycle은 코드 scope에 영향을 받는다.</p></li> <li><p>scope는 주로 메서드호출, while, for문 등에 의해 정의된다.</p></li> <li><p>스코프의 실행이 종료되면 스코프 안의 변수들은 스택에서 제거된다.</p></li> <li><p>메서드 호출 시 변수들은 스택 상단에 위치하며, 다른 메서드를 호출하면 새로운 메서드변수를 스택의 상단에 위치시킨다</p></li></ul> <p>재귀메서드</p> <ul><li>재귀메서드는 자기 자신을 호출하는 메소드이다.</li> <li>스스로를 너무 많이 호출하면 스택영역이 가득차 StackOverFlowError가 발생한다.</li> <li>재귀메서드를 작성하는 경우에는 더 이상 호출이 일나지 않도록 초기조건(base case)으로 메서드 안의 상태를 지정하는 것이 중요하다.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listReversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> givenList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> expectedList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>expectedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">reverseRecursive</span><span class="token punctuation">(</span>givenList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>expectedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">reverseIterative</span><span class="token punctuation">(</span>givenList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">reverseRecursive</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> list<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> reversed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            reversed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            reversed<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">reverseRecursive</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> reversed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">reverseIterative</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> tmp <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>위 소스에서 배열을 뒤집는 두 메소드를 비교해보자</p> <ul><li><p>재귀 메소드(reverseRecursive)에서는 재귀적으로 메소드를 호출할때마다 새로운 리스트가 생성되며, 리스트가 뒤집어질때까지 메모리에 남아있다.<br>
생성된 리스트는 힙영역에 할달되겠지만, 각 호출된 메서드들은 스택역역에 할당된다.</p></li> <li><p>반복문 메소드(reverseIterative)에서는 변수하나만 존재히면 되며, 재귀적 호출이 없어 스택영역이 커지지 않는다.<br>
변수도 하나만 존재하므로 힙영역도 추가적으로 필요하지 않다.</p></li></ul> <h3 id="q2-jvm의-힙-크기는-어떻게-지정할-수-있는가"><a href="#q2-jvm의-힙-크기는-어떻게-지정할-수-있는가" class="header-anchor">#</a> <code>Q2. JVM의 힙 크기는 어떻게 지정할 수 있는가</code></h3> <p>JVM은 각 메모리영역의 할당된 크기를 설정할 수 있는 커멘드 라인을 제공한다.</p> <p>JVM 실행시에 커맨드 라인에 -Xmx 매개변수와 크기를 이용해서 최대 힙 크기를 지정가능하다.<br>
초기 메모리를 지정할 때엔 Xms 매개변수를 이용한다<br>
두 변수를 같게 지정하면 실행시 모든 메모리가 할당되며 더 확장되지 않는다.</p> <div class="language-command extra-class"><pre class="language-text"><code>java -Xmx512M &lt;className&gt;
java -Xms128M &lt;className&gt;
</code></pre></div><p>메모리 할당을 확장하기전 가능한 많은 GC를 수행하며 JVM 실행시 메모리 전체를 할당하지 않는다.
초기 할당(Xms)을 위한 기본값은 컴퓨터 메모리의 1/64 ~ 1G까지이다 .
최대 할당(Xmx)을 위한 기돈앖은 1G보다 작거나 컴퓨터 메모리의 1/4이다.</p> <p>스택 영역도 매개변수로 지정할 수 있으나, 실행중인 프로그램 대부분에는 직접 설정하지 말아야한다.</p> <p>parmanent 제너레이션은 -XX:Persize와 -XX:MaxPerSize 매개변수로 설정 가능하다.
클래스와 String상수를 많이 자용하거나 비자바프로그래밍언어에서 동적클래스를 정의하는 경우 설정한다.</p> <h3 id="q3-자바에서-메모리-누수가-발생할-수-있는가"><a href="#q3-자바에서-메모리-누수가-발생할-수-있는가" class="header-anchor">#</a> <code>Q3. 자바에서 메모리 누수가 발생할 수 있는가?</code></h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryLeakStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> stackValues<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> stackPointer<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MemoryLeakStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stackValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stackPointer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">E</span> element<span class="token punctuation">)</span><span class="token punctuation">{</span>
        stackValues<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stackPointer<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stackPointer<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        stackPointer<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stackValues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>stackPointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>동시성 이슈를 무시하거나 비어있는 스택에서 pop 메서드를 호출하는 것 같은 기본적인 예외가 발생했을때 메모리 누수탐지를 관리해봤는가?
객체를 pop 했을 때 stackValues 인스턴스는 pop된 객체를 가비지걸렉션으로 수집하지 않는다.
push메서드가 호출되어 덮어써지기 전에는 가비지컬렌션에 수집되지 않는다.</p> <p>따라서 pop메서드의 정확한 구현은 remove메서드를 호출하는 것이다.</p> <hr> <h2 id="jvm과-자바-사이의-상호작용"><a href="#jvm과-자바-사이의-상호작용" class="header-anchor">#</a> JVM과 자바 사이의 상호작용</h2> <h3 id="q1-jvm에서-동작하는-실제-자바-코드를-작설할때-생명주기란-무엇인가"><a href="#q1-jvm에서-동작하는-실제-자바-코드를-작설할때-생명주기란-무엇인가" class="header-anchor">#</a> <code>Q1 JVM에서 동작하는 실제 자바 코드를 작설할때 생명주기란 무엇인가?</code></h3> <ul><li><p>자바코드를 JVM d에서 실행시키기 위해선 <strong>컴파일</strong>을 해야한다.<br>
컴파일러는 문법과 타입의 적합성등을 확인해 .class 확장자를 가진 바이트 코드 파일을 생성한다</p></li> <li><p>class파일을 JVM 메모리로 가져오는것을 <strong>클래스 로딩</strong>이라고 한다.<br>
클래스 로더는 클래스파일을 추상화하여 디스크, 네트워크, jar등의 압축파일에서 .class 바이너리 파일을 가져와 메모리에 저장 불러올 수 있다.</p></li> <li><p>사용자가 직접 클래스로더를 만드는 경우엔 특정 위치의 클래스들을 클래스로더에서 사용하도록 지정이 가능하다</p></li> <li><p>클래스가 로드되면 JVM은 바이트코드가 유효한지 <strong>검증</strong>하고 코드의 명령어가 완벽지 확인한다.</p></li> <li><p>검증이 완료되면 JVM 아키텍쳐와 운영체제에 맞게 <strong>바이트코드를 해석</strong>한다.<br>
JLT컴파일러는 직접 동적으로 실행중인 바이트코드를 명령어로 해석하며 동적으로 최적화된 머신코드를 만들수 있다.</p></li></ul> <h3 id="q2-jvm에게-가비지컬렌션-실행하라고-직접-명령-할-수-있는가"><a href="#q2-jvm에게-가비지컬렌션-실행하라고-직접-명령-할-수-있는가" class="header-anchor">#</a> <code>Q2 JVM에게 가비지컬렌션 실행하라고 직접 명령 할 수 있는가?</code></h3> <p>gc는 System 클래스의 전역메서드로 JVM에 가비지 컬렉션을 실행하라고 명령한다.
그러나 이 메서드를 실행한다고 반드시 가비지 컬렌셕이 실행되지는 않는다.</p> <p>JVM은 gc 메서드의 요청을 받아 가능하다면 가비지컬렌셕을 실행하고 실행하는 동안 stop-the-world상태가 된다.<br>
해당 시간동안 모든 스레드가 정지하므로 어플리케이션의 코드실행이 느려질 수 있다.</p> <h3 id="q3-finalize-메서드는-어떤-역할을-수행하는가"><a href="#q3-finalize-메서드는-어떤-역할을-수행하는가" class="header-anchor">#</a> <code>Q3 finalize 메서드는 어떤 역할을 수행하는가?</code></h3> <p>finalize, 소멸자(&lt;-&gt;생성자)는 Object 클래스의 protected 메서드로 가비지컬렌션이 객체를 수집할때 이 메서드를 가장 먼저 호출한다.<br>
즉 가비지 컬렌션에서 메모리 해제를 위해 호출한다.</p> <p>오버라이딩 하는 경우 이 메서그가 언제 호출되는지 제어가 불가능 하나는 점을 염두해야한다.<br>
DB연결을 종료하거나, 파일처리 종료시 이 메서드를 사용가는 경우 메서드가 정확히 실행될 것 이라고 생각하면 안된다.<br>
이런식으로 설정된 객체가 많으면 DB pool 소모, 또는 많은 파일을 열어두게 될수 있다.</p> <p>DB, 파일시스템, 네트워크 인터페이스 등은 가능한 빨리 자원제거를 해주는 것이 좋으며,<br>
자바7의 try-with-resource를 사용하는 것이 좋다.</p> <h3 id="q4-weakreference란-무엇인가"><a href="#q4-weakreference란-무엇인가" class="header-anchor">#</a> <code>Q4 WeakReference란 무엇인가?</code></h3> <p>WeakReference란 제너릭 컨데이너 클래스로서, 들어있는 인스턴스에 강력한 참조가 없으면 가지비컬렉션의 수집대상이 된다.<br>
위 메모리 누수 스택문제를 해결하기 위해서는 원소들의 WeakReferences 리스트를 유지해야 한다.<br>
다른 참조가 없는 원소들은 가비지 컬렉션을 실행할 때 null로 설정된다.</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeakReferenceStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WeakReferenceStack</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> stackReferences<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token keyword">int</span> stackPoint <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">public</span> <span class="token class-name">WeakReferenceStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>stackReferences <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">E</span> element<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>stackReferences<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stackPoint<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">WeakReferenceStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          stackPoint<span class="token operator">==</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          stackPoint<span class="token operator">--</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stackReferences<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>stackPoint<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stackReferences<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>stackPoint<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>스택에 새로운 원소가 들어오면 WeakReferenceStack객체로 저장되며,<br>
객체가 pop될 때에는 WeakReferenceStack 객체를 검색하고 객체를 얻기위해 get메소드가 호출된다.<br>
해당 객체를 가르키는 클라이언트가 없을 경우, 다음 가비지 컬렌션의 삭제대상으로 선택 될 수 있다.</p> <p>peak는 스택상단에 있는 원소를 삭제하지 않고 반환해준다.</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">weakReferencesStackManipulation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">WeakReferenceStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ValueContainer</span><span class="token punctuation">&gt;</span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReferenceStack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ValueContainer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">ValueContainer</span> expected <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ValueContainer</span><span class="token punctuation">(</span><span class="token string">&quot;Value for the stack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueContainer</span><span class="token punctuation">(</span><span class="token string">&quot;Value for the stack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ValueContainer</span> peekedValue <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span>peekedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span>stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        peekedValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNull</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValueContainer</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> value<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">ValueContainer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finalizing for &quot;</span> <span class="token operator">+</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>stack.push(expected)같은 형태로 객체를 삽입하면 강한 참조가 유지된다.<br>
따라서 가비지 컬렉션에서 수집되지 않고 이 테스트는 실패한다.</p> <p>테스트는 peek메소드를 가진 스택을 점검하고 스택에 있는 값이 원하는 값이 맞는지 확인한다.
peekedValue의 참조는 null로 확인하고, 스택의 weakReferences안이 아니면 참조가 없다.<br>
따라서 가지비 컬렉션에서 수집대상이 되어 메모리가 재 배치 되어야 한다.</p> <p>JVM이 가비지컬렌션을 수행한 이후에는 해당 참조를 스택에서 사용할 수 없으며,<br>
finalize가 호출되었을때 표준출력에서 메세지를 확인해야 한다.</p> <h3 id="q5-native-메서드란-무엇인가"><a href="#q5-native-메서드란-무엇인가" class="header-anchor">#</a> <code>Q5 native 메서드란 무엇인가?</code></h3> <p>Java Native Method (JNI)는 다른 언어로 작성된 코드를 자바에서 사용가능하도록 한다.</p> <p>정상적인 자바 클래스는 바이트 코드로 컴파일해 클래스파일로 저장된다.<br>
바이트 코드는 플랫폼에 독립적으로 바이트코드를 실행하는 아키텍쳐와 운영체제의 명령어로 해석된다.</p> <p>이 경우 플랫폼의 지정코드, 라이브러리, 디스트, 네트워크 인터페이스 등에 자원을 호출해야 하며,<br>
대부분 JVM을 이용하는 플랫폼에 구현되어 있다.</p> <p>자원호출이 불가한 경우에는 navive메서드를 이용 할 수 있다.<br>
이 메서드를 통해서 클래스이름, 자바메서드 이름, 매개변수, 반환타입을 구분 가능하낟.</p> <h3 id="q6-셧다운-훅이란-무엇인가"><a href="#q6-셧다운-훅이란-무엇인가" class="header-anchor">#</a> <code>Q6 셧다운 훅이란 무엇인가?</code></h3> <p>객체가 가비지컬렌션 되기 전에 finalize가 실행되듯이, JVM이 종료되기 전에 실행된다.<br>
즉, 어플리케이션을 안전하게 종료하기 위해 ..?
shutdown-hook은 Thread 객체에 대한 참조로서, runtime 인스턴스의 addShutDownHook메서드를 호출에 새로운 참조를 추가한다.</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting sown JVM at time : &quot;</span><span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>셧다운 훗은 종료 코드에서 실행된다.<br>
위의 코드는 JVM이 종료될때 시간로그를 남기는 코드이다.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sunny-archive/java/interview_Expose/Chapter08.html" class="prev">
        Chapter08# 자바기본(1)
      </a></span> <span class="next"><a href="/sunny-archive/java/interview_Expose/Chapter14.html">
        Chapter14# HTTP
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sunny-archive/assets/js/app.20f77d52.js" defer></script><script src="/sunny-archive/assets/js/2.511b4fc5.js" defer></script><script src="/sunny-archive/assets/js/4.360058bb.js" defer></script>
  </body>
</html>
